# RadioNowhere å¼€å‘è·¯çº¿å›¾

> ç‰ˆæœ¬ï¼šv2.0 | æœ€åæ›´æ–°ï¼š2026-02-08

---

## ç›®å½•

1. [é¡¹ç›®æ„¿æ™¯](#ä¸€é¡¹ç›®æ„¿æ™¯)
2. [æ¶æ„è§„èŒƒ](#äºŒæ¶æ„è§„èŒƒ)
3. [å¼€å‘æ ‡å‡†](#ä¸‰å¼€å‘æ ‡å‡†)
4. [ä»»åŠ¡æ¸…å•](#å››ä»»åŠ¡æ¸…å•)
5. [å®æ–½è®¡åˆ’](#äº”å®æ–½è®¡åˆ’)
6. [æˆåŠŸæŒ‡æ ‡](#å…­æˆåŠŸæŒ‡æ ‡)

---

## ä¸€ã€é¡¹ç›®æ„¿æ™¯

### 1.1 å½“å‰çŠ¶æ€

RadioNowhere æ˜¯ä¸€ä¸ª AI é©±åŠ¨çš„ç½‘ç»œç”µå°ï¼Œç›®å‰å®ç°äº†ï¼š
- âœ… åŸºç¡€æ’­æ”¾å™¨ UI
- âœ… TTS è¯­éŸ³åˆæˆï¼ˆMicrosoft/Geminiï¼‰
- âœ… éŸ³ä¹æœç´¢ä¸æ’­æ”¾
- âœ… å¤šä¸»æŒäººç³»ç»Ÿ
- âœ… ReAct Agent å†…å®¹ç”Ÿæˆ

### 1.2 æ ¸å¿ƒé—®é¢˜

| é—®é¢˜ | è¡¨ç° | å½±å“ |
|------|------|------|
| èŠ‚ç›®åŒè´¨åŒ– | éƒ½æ˜¯"é¸¡æ±¤æ–‡+éŸ³ä¹" | ç”¨æˆ·ä½“éªŒå•è°ƒ |
| éŸ³ä¹åå¥½å›ºå®š | æ€»æ˜¯é€‰ç›¸åŒæ­Œæ‰‹ | ç¼ºä¹æ–°é²œæ„Ÿ |
| å†…å®¹æ·±åº¦ä¸è¶³ | å¯¹è¯æµ…è–„ç©ºæ´ | æ— çœŸå®ç”µå°æ„Ÿ |
| Agent èŒè´£ä¸æ¸… | å•ä¸€ Writer å¤„ç†æ‰€æœ‰ | éš¾ä»¥ä¼˜åŒ– |

### 1.3 ç›®æ ‡çŠ¶æ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RadioNowhere v2.0                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ™ï¸ å¤šæ ·åŒ–èŠ‚ç›®ç±»å‹                                      â”‚
â”‚     - æ–°é—»æ’­æŠ¥ã€è„±å£ç§€ã€å†å²æ•…äº‹ã€éŸ³ä¹ä¸“é¢˜...            â”‚
â”‚                                                        â”‚
â”‚  ğŸµ æ™ºèƒ½éŸ³ä¹æ¨è                                        â”‚
â”‚     - æ›²é£ç»´åº¦é©±åŠ¨ï¼Œé¿å…æ­Œæ‰‹åå¥½                         â”‚
â”‚     - æ ¹æ®èŠ‚ç›®ç±»å‹è‡ªåŠ¨è°ƒæ•´éŸ³ä¹é…æ¯”                       â”‚
â”‚                                                        â”‚
â”‚  ğŸ¤– ä¸“ä¸šåŒ– Agent ç³»ç»Ÿ                                   â”‚
â”‚     - èŒè´£åˆ†ç¦»ï¼Œæ¯ç±»èŠ‚ç›®æœ‰ä¸“å± Writer                    â”‚
â”‚     - å¯æ‰©å±•å·¥å…·ç³»ç»Ÿ                                    â”‚
â”‚                                                        â”‚
â”‚  ğŸ‘¤ ä¸ªæ€§åŒ–ä½“éªŒï¼ˆæœªæ¥ï¼‰                                  â”‚
â”‚     - ç”¨æˆ·åå¥½è®¾ç½®                                      â”‚
â”‚     - æ™ºèƒ½æ¨è                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ¶æ„è§„èŒƒ

### 2.1 é¡¹ç›®ç»“æ„ï¼ˆFeature-Sliced Designï¼‰

```
src/
â”œâ”€â”€ app/                    # Next.js App Router
â”œâ”€â”€ features/               # ä¸šåŠ¡åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ agents/             # Agent è°ƒåº¦ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ director-agent.ts      # æ€»å¯¼æ¼”
â”‚   â”‚   â”‚   â”œâ”€â”€ director-types.ts      # ç±»å‹å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ playback-controller.ts # æ’­æ”¾æ§åˆ¶
â”‚   â”‚   â”‚   â”œâ”€â”€ preload-manager.ts     # é¢„åŠ è½½
â”‚   â”‚   â”‚   â”œâ”€â”€ talk-executor.ts       # å¯¹è¯æ‰§è¡Œ
â”‚   â”‚   â”‚   â””â”€â”€ music-executor.ts      # éŸ³ä¹æ‰§è¡Œ
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ content/            # å†…å®¹ç”Ÿæˆæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ writer-agent.ts        # ç¼–å‰§ Agent
â”‚   â”‚   â”‚   â”œâ”€â”€ cast-system.ts         # è§’è‰²ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”œâ”€â”€ show-config.ts         # èŠ‚ç›®é…ç½® [NEW]
â”‚   â”‚   â”‚   â”œâ”€â”€ writer-tools.ts        # å·¥å…·ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”œâ”€â”€ response-parser.ts     # å“åº”è§£æ
â”‚   â”‚   â”‚   â””â”€â”€ prompt-templates/      # Prompt æ¨¡æ¿ [NEW]
â”‚   â”‚   â”‚       â”œâ”€â”€ base.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ talk.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ news.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ story.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ music.ts
â”‚   â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ music-search/       # éŸ³ä¹æœç´¢æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ gd-music-service.ts    # éŸ³ä¹ API
â”‚   â”‚   â”‚   â”œâ”€â”€ diversity-manager.ts   # å¤šæ ·æ€§ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ genre-wheel.ts         # æ›²é£è½®ç›˜ [NEW]
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ tts/                # TTS æ¨¡å—
â”‚   â”œâ”€â”€ feedback/           # ç”¨æˆ·åé¦ˆæ¨¡å—
â”‚   â””â”€â”€ history-tracking/   # å†å²è®°å½•æ¨¡å—
â”‚
â”œâ”€â”€ shared/                 # å…±äº«æ¨¡å—
â”‚   â”œâ”€â”€ services/           # åŸºç¡€æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ audio-service/  # éŸ³é¢‘æ··éŸ³å™¨
â”‚   â”‚   â”œâ”€â”€ monitor-service/# äº‹ä»¶ç›‘æ§
â”‚   â”‚   â””â”€â”€ storage-service/# å­˜å‚¨æœåŠ¡
â”‚   â”œâ”€â”€ stores/             # å…¨å±€çŠ¶æ€
â”‚   â”œâ”€â”€ types/              # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ radio-core.ts   # æ ¸å¿ƒç±»å‹
â”‚   â”‚   â””â”€â”€ segment.ts      # ç¯èŠ‚ç±»å‹ [NEW]
â”‚   â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
â”‚
â””â”€â”€ widgets/                # UI ç»„ä»¶
    â””â”€â”€ radio-player/
        â”œâ”€â”€ ui/
        â”‚   â”œâ”€â”€ index.tsx
        â”‚   â”œâ”€â”€ SubtitleDisplay.tsx
        â”‚   â”œâ”€â”€ TimelinePanel.tsx
        â”‚   â”œâ”€â”€ MailboxDrawer.tsx
        â”‚   â””â”€â”€ PlayerActionBtn.tsx
        â”œâ”€â”€ hooks/
        â”‚   â””â”€â”€ useRadioPlayer.ts
        â””â”€â”€ types.ts
```

### 2.2 Agent ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DirectorAgent                           â”‚
â”‚                   (æ€»å¯¼æ¼”ï¼šè°ƒåº¦ã€å†³ç­–)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚               â”‚
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚WriterAgent â”‚  â”‚ TTS Agent  â”‚  â”‚AudioMixer  â”‚
    â”‚  (ç¼–å‰§)    â”‚  â”‚ (è¯­éŸ³åˆæˆ) â”‚  â”‚ (æ··éŸ³å™¨)   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ æ ¹æ® ShowType é€‰æ‹©
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           Prompt Templates               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  talk   â”‚  news   â”‚  story  â”‚   music   â”‚
    â”‚ è„±å£ç§€  â”‚ æ–°é—»    â”‚ æ•…äº‹    â”‚  éŸ³ä¹ä¸“é¢˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ æ ¹æ® ShowConfig é€‰æ‹©
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              Tool System                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ search_music | fetch_news | search_knowledge â”‚
    â”‚ get_lyrics   | fetch_trending | submit_show  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ•°æ®æµ

```
ç”¨æˆ·ç‚¹å‡»æ’­æ”¾
    â”‚
    â–¼
DirectorAgent.startShow()
    â”‚
    â”œâ”€â†’ CastDirector.randomShowType()  // å†³å®šèŠ‚ç›®ç±»å‹
    â”‚       â”‚
    â”‚       â–¼
    â”œâ”€â†’ WriterAgent.generateTimeline()
    â”‚       â”‚
    â”‚       â”œâ”€â†’ getShowConfig(type)     // è·å–èŠ‚ç›®é…ç½®
    â”‚       â”œâ”€â†’ getPromptTemplate(type) // è·å–ä¸“å± Prompt
    â”‚       â”œâ”€â†’ getToolsForType(type)   // è·å–ä¸“å±å·¥å…·
    â”‚       â””â”€â†’ AI ç”Ÿæˆ â†’ ShowTimeline
    â”‚
    â”œâ”€â†’ prepareBlocks()                 // é¢„åŠ è½½éŸ³é¢‘
    â”‚       â”œâ”€â†’ TalkExecutor.prepare()  // TTS åˆæˆ
    â”‚       â””â”€â†’ MusicExecutor.prepare() // éŸ³ä¹ä¸‹è½½
    â”‚
    â””â”€â†’ executeTimeline()               // æ‰§è¡Œæ’­æ”¾
            â”‚
            â”œâ”€â†’ radioMonitor.emit()     // å‘é€äº‹ä»¶
            â””â”€â†’ UI æ›´æ–°
```

### 2.4 èŠ‚ç›®ç±»å‹é…æ¯”è§„èŒƒ

| ShowType | å¯¹è¯å æ¯” | éŸ³ä¹å æ¯” | éŸ³ä¹ç”¨é€” | å¿…éœ€å·¥å…· |
|----------|----------|----------|----------|----------|
| talk | 60-70% | 30-40% | èƒŒæ™¯+è¿‡æ¸¡ | - |
| entertainment | 60-70% | 30-40% | èƒŒæ™¯+è¿‡æ¸¡ | fetch_trending |
| news | 80-90% | 10-20% | ä»…è¿‡æ¸¡ | fetch_news |
| history | 70-80% | 20-30% | æ°›å›´+è¿‡æ¸¡ | search_knowledge |
| science | 70-80% | 20-30% | æ°›å›´+è¿‡æ¸¡ | search_knowledge |
| mystery | 75-85% | 15-25% | æ°›å›´çƒ˜æ‰˜ | - |
| story | 65-75% | 25-35% | æƒ…æ„Ÿæ¸²æŸ“ | - |
| nighttalk | 65-75% | 25-35% | æƒ…æ„Ÿæ¸²æŸ“ | search_quotes |
| music | 30-40% | 60-70% | ä¸»ä½“å†…å®¹ | search_music, get_lyrics |
| interview | 70-80% | 20-30% | è¿‡æ¸¡ | - |
| drama | 85-95% | 5-15% | åœºæ™¯+è¿‡æ¸¡ | - |

---

## ä¸‰ã€å¼€å‘æ ‡å‡†

### 3.1 ä»£ç è§„èŒƒ

```typescript
// âœ… å¥½çš„åšæ³•
export interface ShowConfig {
    type: ShowType;
    talkRatio: [number, number];     // [min, max]
    musicRatio: [number, number];
    musicPurpose: MusicPurpose;
    requiredTools: ToolName[];
    optionalTools: ToolName[];
}

// âŒ é¿å…çš„åšæ³•
export interface Config {
    t: string;      // ä¸æ¸…æ™°çš„å‘½å
    tr: number[];   // ç¼ºå°‘ç±»å‹çº¦æŸ
    mp: string;     // åº”ä½¿ç”¨æšä¸¾
}
```

### 3.2 æ–‡ä»¶å‘½åè§„èŒƒ

| ç±»å‹ | å‘½åè§„åˆ™ | ç¤ºä¾‹ |
|------|----------|------|
| ç»„ä»¶ | PascalCase | `SubtitleDisplay.tsx` |
| Hook | camelCase + useå‰ç¼€ | `useRadioPlayer.ts` |
| å·¥å…·å‡½æ•° | camelCase | `diversity-manager.ts` |
| ç±»å‹å®šä¹‰ | kebab-case | `radio-core.ts` |
| å¸¸é‡ | UPPER_SNAKE_CASE | `SHOW_CONFIGS` |

### 3.3 Prompt ç¼–å†™è§„èŒƒ

```typescript
// âœ… å¥½çš„ Prompt ç»“æ„
const PROMPT_TEMPLATE = `
## ğŸ¯ ä»»åŠ¡ç›®æ ‡
[æ¸…æ™°æè¿°è¦åšä»€ä¹ˆ]

## ğŸ“‹ ç»“æ„è¦æ±‚
[å…·ä½“çš„ç»“æ„å’Œæ ¼å¼]

## âœ… æœŸæœ›çš„è¡¨è¾¾
[æ­£é¢ç¤ºä¾‹]

## âŒ ç¦æ­¢çš„å†…å®¹
[è´Ÿé¢ç¤ºä¾‹]

## ğŸ› ï¸ å¯ç”¨å·¥å…·
[å·¥å…·åˆ—è¡¨å’Œç”¨æ³•]
`;

// âŒ é¿å…çš„ Prompt
const BAD_PROMPT = `
è¯·ç”Ÿæˆä¸€ä¸ªå¥½çš„èŠ‚ç›®ã€‚è¦æœ‰è¶£ï¼Œè¦æ·±åˆ»ã€‚
`;  // å¤ªæ¨¡ç³Šï¼Œç¼ºä¹å…·ä½“æŒ‡å¯¼
```

### 3.4 å·¥å…·å®šä¹‰è§„èŒƒ

```typescript
// âœ… æ ‡å‡†å·¥å…·å®šä¹‰
export const TOOL_DEFINITION: ToolDefinition = {
    name: 'search_knowledge',
    description: `æœç´¢çŸ¥è¯†/ç™¾ç§‘å†…å®¹ã€‚

é€‚ç”¨åœºæ™¯ï¼š
- å†å²æ•…äº‹èŠ‚ç›®éœ€è¦å²å®ä¾æ®
- ç§‘æ™®èŠ‚ç›®éœ€è¦ç§‘å­¦åŸç†
- æ–‡åŒ–èŠ‚ç›®éœ€è¦èƒŒæ™¯çŸ¥è¯†

è¿”å›æ ¼å¼ï¼š
- title: æ¡ç›®æ ‡é¢˜
- summary: æ‘˜è¦ï¼ˆ100-200å­—ï¼‰
- source: æ¥æº`,
    parameters: [
        {
            name: 'query',
            type: 'string',
            description: 'æœç´¢å…³é”®è¯ï¼ˆå¦‚ï¼šä¸‰å›½æ¼”ä¹‰ã€é‡å­åŠ›å­¦ã€èŒ¶é“æ–‡åŒ–ï¼‰',
            required: true
        },
        {
            name: 'type',
            type: 'string',
            description: 'çŸ¥è¯†ç±»å‹ï¼šhistory/science/culture/general',
            required: false
        }
    ]
};
```

### 3.5 çŠ¶æ€ç®¡ç†è§„èŒƒ

```typescript
// âœ… ä½¿ç”¨ React Context + Hooks
export function useRadioPlayer(): RadioPlayerState & RadioPlayerActions {
    const [state, setState] = useState<RadioPlayerState>(initialState);

    // ä½¿ç”¨ useCallback ç¼“å­˜æ–¹æ³•
    const togglePlayback = useCallback(async () => {
        // ...
    }, [dependencies]);

    // ä½¿ç”¨ useEffect è®¢é˜…äº‹ä»¶
    useEffect(() => {
        const cleanup = radioMonitor.on('script', handler);
        return cleanup;
    }, []);

    return { ...state, togglePlayback };
}

// âŒ é¿å…çš„åšæ³•
// ç›´æ¥åœ¨ç»„ä»¶å†…å®šä¹‰å¤æ‚é€»è¾‘
// ä¸ä½¿ç”¨ useCallback å¯¼è‡´é‡å¤æ¸²æŸ“
// ä¸æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
```

### 3.6 é”™è¯¯å¤„ç†è§„èŒƒ

```typescript
// âœ… æ ‡å‡†é”™è¯¯å¤„ç†
async function executeToolCall(name: string, args: unknown): Promise<ToolResult> {
    try {
        const result = await doSomething(args);
        return { success: true, data: result };
    } catch (error) {
        // è®°å½•æ—¥å¿—
        radioMonitor.log('WRITER', `Tool ${name} failed: ${error}`, 'error');

        // è¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯
        return {
            success: false,
            error: `å·¥å…·æ‰§è¡Œå¤±è´¥ï¼š${getErrorMessage(error)}`
        };
    }
}

// âŒ é¿å…çš„åšæ³•
async function badExample() {
    const result = await doSomething(); // æ²¡æœ‰ try-catch
    return result; // é”™è¯¯ä¼šå¯¼è‡´æ•´ä¸ªæµç¨‹å´©æºƒ
}
```

---

## å››ã€ä»»åŠ¡æ¸…å•

### 4.1 Bug ä¿®å¤ (P0)

#### BUG-001: å°è¯å±•å¼€çŠ¶æ€å¼‚å¸¸
- **æ–‡ä»¶**: `src/widgets/radio-player/ui/SubtitleDisplay.tsx`
- **é—®é¢˜**: Talk block å±•å¼€æ—¶åˆ‡æ¢åˆ° music blockï¼ŒUI è¿›å…¥å¼‚å¸¸çŠ¶æ€
- **ä¿®å¤**:
```typescript
// åœ¨ç¬¬ 101 è¡Œ useEffect åæ·»åŠ 
useEffect(() => {
    if (displayInfo.type !== 'talk' && isExpanded) {
        onExpandChange(false);
    }
}, [displayInfo.type, isExpanded, onExpandChange]);
```
- [ ] å®ç°ä¿®å¤
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹
- [ ] éªŒè¯ï¼štalk â†’ music åˆ‡æ¢æ—¶è‡ªåŠ¨æ”¶èµ·

#### BUG-002: æ‰‹æœºçª„å±è¾“å…¥æ¡†é€‚é…
- **æ–‡ä»¶**: `src/widgets/radio-player/ui/MailboxDrawer.tsx`
- **é—®é¢˜**: 320px å±å¹•ä¸Šè¾“å…¥æ¡†å’ŒæŒ‰é’®è¢«æŒ¤å‹
- **ä¿®å¤**:
```typescript
// ç¬¬ 36 è¡Œ
className="mt-6 w-full max-w-[calc(100vw-2rem)] sm:max-w-md mx-auto"

// ç¬¬ 73, 86 è¡ŒæŒ‰é’®
className="p-2 sm:p-2.5 rounded-xl ..."
```
- [ ] å®ç°å“åº”å¼ä¿®å¤
- [ ] æµ‹è¯• 320pxã€375pxã€414px å±å¹•

#### BUG-003: æ‰¹é‡ TTS å°è¯æ˜¾ç¤ºåŒæ­¥
- **æ–‡ä»¶**: `src/widgets/radio-player/ui/SubtitleDisplay.tsx`
- **é—®é¢˜**: Gemini æ‰¹é‡ TTS æ—¶ï¼Œåªæ˜¾ç¤ºæœ€åä¸€å¥å°è¯
- **ä¿®å¤**: å¤„ç† `isBatched` å’Œ `batchScripts` å­—æ®µ
- [ ] ä¿®æ”¹ SubtitleDisplay å¤„ç†æ‰¹é‡è„šæœ¬
- [ ] æµ‹è¯•å¤šäººå¯¹è¯æ˜¾ç¤º

#### BUG-004: ç¦æ­¢åˆ—è¡¨æŒä¹…åŒ–
- **æ–‡ä»¶**: `src/features/music-search/lib/diversity-manager.ts`
- **é—®é¢˜**: åˆ·æ–°é¡µé¢åç¦æ­¢åˆ—è¡¨é‡ç½®
- **ä¿®å¤**: ä½¿ç”¨ localStorage æŒä¹…åŒ–
- [ ] æ·»åŠ  load/save å‡½æ•°
- [ ] SSR å…¼å®¹å¤„ç†

---

### 4.2 èŠ‚ç›®ä¸°å¯Œåº¦ (P1)

#### FEAT-001: å¯ç”¨å…¨éƒ¨èŠ‚ç›®ç±»å‹
- **æ–‡ä»¶**: `src/features/content/lib/cast-system.ts`
- **æ”¹åŠ¨**: ä¿®æ”¹ `randomShowType()` ä½¿ç”¨åŠ æƒéšæœº
```typescript
const weights: Record<ShowType, number> = {
    talk: 15, interview: 10, news: 8, drama: 5,
    entertainment: 12, story: 10, history: 10,
    science: 10, mystery: 10, nighttalk: 8, music: 5
};
```
- [ ] å®ç°åŠ æƒéšæœº
- [ ] å¯ç”¨ news å’Œ drama
- [ ] éªŒè¯ç±»å‹åˆ†å¸ƒ

#### FEAT-002: èŠ‚ç›®é…ç½®ç³»ç»Ÿ
- **æ–°æ–‡ä»¶**: `src/features/content/lib/show-config.ts`
- **å†…å®¹**: å®šä¹‰å„ç±»å‹çš„å¯¹è¯/éŸ³ä¹é…æ¯”
- [ ] åˆ›å»º ShowConfig æ¥å£
- [ ] å®šä¹‰ SHOW_CONFIGS å¸¸é‡
- [ ] å¯¼å‡ºé…ç½®è·å–å‡½æ•°

#### FEAT-003: ä¸“å± Prompt æ¨¡æ¿
- **æ–°ç›®å½•**: `src/features/content/lib/prompt-templates/`
- **æ–‡ä»¶**:
  - [ ] `base.ts` - å…¬å…±éƒ¨åˆ†ï¼ˆç”µå°èº«ä»½ã€è¾“å‡ºæ ¼å¼ï¼‰
  - [ ] `talk.ts` - è„±å£ç§€ä¸“å±
  - [ ] `news.ts` - æ–°é—»æ’­æŠ¥ä¸“å±
  - [ ] `story.ts` - æ•…äº‹/å†å²ä¸“å±
  - [ ] `music.ts` - éŸ³ä¹ä¸“é¢˜ä¸“å±
  - [ ] `entertainment.ts` - å¨±ä¹ç»¼è‰ºä¸“å±
  - [ ] `index.ts` - æ¨¡æ¿é€‰æ‹©å™¨

#### FEAT-004: å¯¹è¯æ¨¡å¼å¼•å¯¼
- **æ–‡ä»¶**: `src/features/content/lib/prompt-templates/talk.ts`
- **å†…å®¹**: å®šä¹‰è¾©è®ºå¼ã€å™äº‹æ¥åŠ›ã€åæ§½å¼ç­‰å¯¹è¯æ¨¡å¼
- [ ] ç¼–å†™å¯¹è¯æ¨¡å¼æè¿°
- [ ] æ·»åŠ æ­£åé¢ç¤ºä¾‹
- [ ] é›†æˆåˆ° Prompt

#### FEAT-005: å†…å®¹å¯†åº¦æå‡
- **æ–‡ä»¶**: å„ `prompt-templates/*.ts`
- **æ”¹åŠ¨**: å°è¯è¦æ±‚ 3-5 å¥ â†’ 8-12 å¥
- [ ] ä¿®æ”¹æ•°é‡è¦æ±‚
- [ ] æ·»åŠ ç¦æ­¢è¡¨è¾¾æ¸…å•
- [ ] æ·»åŠ æœŸæœ›è¡¨è¾¾ç¤ºä¾‹

---

### 4.3 éŸ³ä¹å¤šæ ·æ€§ (P1)

#### FEAT-006: æ›²é£è½®ç›˜ç³»ç»Ÿ
- **æ–°æ–‡ä»¶**: `src/features/music-search/lib/genre-wheel.ts`
- **å†…å®¹**:
```typescript
export const GENRE_DIMENSIONS = [
    { name: 'æµæ´¾', options: ['æ°‘è°£/Folk', 'æ‘‡æ»š/Rock', ...] },
    { name: 'å¹´ä»£', options: ['60å¹´ä»£', '70å¹´ä»£', ...] },
    { name: 'æ–‡åŒ–', options: ['åè¯­', 'æ¬§ç¾', 'æ—¥éŸ©', ...] },
    { name: 'æ°›å›´', options: ['æ²»æ„ˆ', 'æ¿€æƒ…', 'å¿§éƒ', ...] }
];
```
- [ ] å®šä¹‰æ›²é£ç»´åº¦
- [ ] å®ç° getGenreSuggestions()
- [ ] å®ç° recordUsedGenre()
- [ ] å®ç° getGenrePromptSection()

#### FEAT-007: éŸ³ä¹ä¸“é¢˜èŠ‚ç›®æ›²é£å¼•å¯¼
- **æ–‡ä»¶**: `src/features/content/lib/writer-agent.ts`
- **æ”¹åŠ¨**: ä»…åœ¨ music ç±»å‹èŠ‚ç›®ä½¿ç”¨æ›²é£è½®ç›˜
- [ ] å¼•å…¥ genre-wheel
- [ ] åœ¨ music èŠ‚ç›® Prompt ä¸­æ·»åŠ æ›²é£å¼•å¯¼
- [ ] å…¶ä»–èŠ‚ç›®ç±»å‹ä¸å¼ºåˆ¶æ›²é£è¦æ±‚

#### FEAT-008: æœç´¢å·¥å…·æ›²é£æç¤º
- **æ–‡ä»¶**: `src/features/content/lib/writer-tools.ts`
- **æ”¹åŠ¨**: å¢åŠ  genre_hint å‚æ•°
- [ ] ä¿®æ”¹å·¥å…·æè¿°
- [ ] å¢åŠ å‚æ•°
- [ ] ä¼˜åŒ–è¿”å›æç¤º

---

### 4.4 Agent ç³»ç»Ÿå‡çº§ (P2)

#### ARCH-001: WriterAgent é‡æ„
- **æ–‡ä»¶**: `src/features/content/lib/writer-agent.ts`
- **æ”¹åŠ¨**:
```typescript
async generateTimeline(duration: number, showType?: ShowType) {
    const type = showType || castDirector.randomShowType();
    const config = getShowConfig(type);
    const prompt = this.buildPromptForType(type, config, duration);
    const tools = this.getToolsForType(type, config);
    return this.executeGeneration(prompt, tools);
}
```
- [ ] å®ç° buildPromptForType()
- [ ] å®ç° getToolsForType()
- [ ] é‡æ„ generateTimeline()
- [ ] è¿ç§»ç°æœ‰é€»è¾‘

#### ARCH-002: å·¥å…·ç³»ç»Ÿæ‰©å±•
- **æ–‡ä»¶**: `src/features/content/lib/writer-tools.ts`
- **æ–°å·¥å…·**:
  - [ ] `search_knowledge` - çŸ¥è¯†/ç™¾ç§‘æœç´¢
  - [ ] `fetch_trending` - çƒ­ç‚¹è¯é¢˜
  - [ ] `search_quotes` - åè¨€é‡‘å¥
  - [ ] `fetch_weather` - å¤©æ°”ä¿¡æ¯
- [ ] å®šä¹‰å·¥å…·æ¥å£
- [ ] å®ç°å·¥å…·é€»è¾‘
- [ ] å¯¹æ¥å¤–éƒ¨ API

#### ARCH-003: èŠ‚ç›®ç¯èŠ‚ç³»ç»Ÿ
- **æ–°æ–‡ä»¶**: `src/shared/types/segment.ts`
- **å†…å®¹**:
```typescript
export type SegmentType =
    | 'opening' | 'main_topic' | 'music_break'
    | 'interaction' | 'closing';

export interface ShowSegment {
    type: SegmentType;
    durationHint: [number, number];
    blocks: TimelineBlock[];
}
```
- [ ] å®šä¹‰ç¯èŠ‚ç±»å‹
- [ ] å®šä¹‰å„èŠ‚ç›®ç±»å‹çš„ç¯èŠ‚ç»“æ„
- [ ] ä¿®æ”¹ WriterAgent æŒ‰ç¯èŠ‚ç”Ÿæˆ

---

### 4.5 åŠŸèƒ½æ‰©å±• (P3)

#### FEAT-009: ç”¨æˆ·åå¥½ç³»ç»Ÿ
- **æ–°æ–‡ä»¶**: `src/features/user-preferences/`
- **å†…å®¹**:
```typescript
interface UserPreference {
    favoriteGenres: string[];
    dislikedGenres: string[];
    favoriteShowTypes: ShowType[];
    explorationLevel: 'conservative' | 'balanced' | 'adventurous';
}
```
- [ ] è®¾è®¡æ•°æ®ç»“æ„
- [ ] åˆ›å»ºè®¾ç½® UI
- [ ] æŒä¹…åŒ–åˆ° localStorage
- [ ] é›†æˆåˆ°å†…å®¹ç”Ÿæˆ

#### FEAT-010: å®Œæ•´å¹¿æ’­å‰§æ”¯æŒ
- [ ] è®¾è®¡å¤šè§’è‰²åœºæ™¯ç³»ç»Ÿ
- [ ] å®ç°ç®€å•éŸ³æ•ˆæ”¯æŒ
- [ ] åˆ›å»º drama ä¸“å± Prompt
- [ ] æµ‹è¯•å¤šè§’è‰²å¯¹è¯

---

## äº”ã€å®æ–½è®¡åˆ’

### Phase 1: ç´§æ€¥ä¿®å¤ï¼ˆ1-3 å¤©ï¼‰

| ä»»åŠ¡ ID | ä»»åŠ¡åç§° | æ–‡ä»¶ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|----------|------|--------|------|
| BUG-001 | å±•å¼€çŠ¶æ€ä¿®å¤ | SubtitleDisplay.tsx | P0 | [ ] |
| BUG-002 | çª„å±é€‚é… | MailboxDrawer.tsx | P0 | [ ] |
| BUG-004 | ç¦æ­¢åˆ—è¡¨æŒä¹…åŒ– | diversity-manager.ts | P0 | [ ] |

**äº¤ä»˜ç‰©**:
- ä¿®å¤åçš„ç»„ä»¶
- æµ‹è¯•é€šè¿‡æˆªå›¾

---

### Phase 2: æ ¸å¿ƒä¼˜åŒ–ï¼ˆ1-2 å‘¨ï¼‰

| ä»»åŠ¡ ID | ä»»åŠ¡åç§° | æ–‡ä»¶ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|----------|------|--------|------|
| FEAT-001 | å¯ç”¨å…¨éƒ¨èŠ‚ç›®ç±»å‹ | cast-system.ts | P1 | [ ] |
| FEAT-002 | èŠ‚ç›®é…ç½®ç³»ç»Ÿ | show-config.ts (æ–°) | P1 | [ ] |
| FEAT-003 | ä¸“å± Prompt æ¨¡æ¿ | prompt-templates/ (æ–°) | P1 | [ ] |
| FEAT-004 | å¯¹è¯æ¨¡å¼å¼•å¯¼ | prompt-templates/talk.ts | P1 | [ ] |
| FEAT-005 | å†…å®¹å¯†åº¦æå‡ | prompt-templates/*.ts | P1 | [ ] |
| BUG-003 | æ‰¹é‡ TTS æ˜¾ç¤º | SubtitleDisplay.tsx | P1 | [ ] |

**äº¤ä»˜ç‰©**:
- æ–°å¢é…ç½®æ–‡ä»¶
- Prompt æ¨¡æ¿ç›®å½•
- æ›´æ–°åçš„ WriterAgent

---

### Phase 3: Agent ç³»ç»Ÿå‡çº§ï¼ˆ2-4 å‘¨ï¼‰

| ä»»åŠ¡ ID | ä»»åŠ¡åç§° | æ–‡ä»¶ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|----------|------|--------|------|
| ARCH-001 | WriterAgent é‡æ„ | writer-agent.ts | P2 | [ ] |
| FEAT-006 | æ›²é£è½®ç›˜ç³»ç»Ÿ | genre-wheel.ts (æ–°) | P2 | [ ] |
| FEAT-007 | éŸ³ä¹èŠ‚ç›®æ›²é£å¼•å¯¼ | writer-agent.ts | P2 | [ ] |
| ARCH-002 | å·¥å…·ç³»ç»Ÿæ‰©å±• | writer-tools.ts | P2 | [ ] |
| ARCH-003 | èŠ‚ç›®ç¯èŠ‚ç³»ç»Ÿ | segment.ts (æ–°) | P2 | [ ] |

**äº¤ä»˜ç‰©**:
- é‡æ„åçš„ Agent ç³»ç»Ÿ
- æ–°å·¥å…·å®ç°
- ç¯èŠ‚ç³»ç»ŸåŸå‹

---

### Phase 4: åŠŸèƒ½æ‰©å±•ï¼ˆ4-8 å‘¨ï¼‰

| ä»»åŠ¡ ID | ä»»åŠ¡åç§° | æ–‡ä»¶ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|----------|------|--------|------|
| ARCH-002.1 | search_knowledge å·¥å…· | writer-tools.ts | P3 | [ ] |
| ARCH-002.2 | fetch_trending å·¥å…· | writer-tools.ts | P3 | [ ] |
| FEAT-009 | ç”¨æˆ·åå¥½ç³»ç»Ÿ | user-preferences/ (æ–°) | P3 | [ ] |
| FEAT-010 | å¹¿æ’­å‰§å®Œæ•´æ”¯æŒ | å¤šæ–‡ä»¶ | P3 | [ ] |

**äº¤ä»˜ç‰©**:
- å®Œæ•´å·¥å…·ç³»ç»Ÿ
- ç”¨æˆ·åå¥½ UI
- å¹¿æ’­å‰§æ¼”ç¤º

---

## å…­ã€æˆåŠŸæŒ‡æ ‡

### 6.1 é‡åŒ–æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | Phase 2 ç›®æ ‡ | Phase 4 ç›®æ ‡ |
|------|--------|--------------|--------------|
| èŠ‚ç›®ç±»å‹è¦†ç›– | 3-4 ç§ | 8+ ç§ | 11 ç§ |
| æ¯æœŸå¹³å‡å°è¯æ•° | 15-20 å¥ | 40+ å¥ | 50+ å¥ |
| çº¯å¯¹è¯èŠ‚ç›®å æ¯” | 0% | 20% | 30-40% |
| æ­Œæ‰‹é‡å¤ç‡ï¼ˆè¿ç»­3æœŸï¼‰ | 50%+ | 20% | <10% |
| èŠ‚ç›®é…æ¯”æ­£ç¡®ç‡ | - | 80% | 95% |

### 6.2 è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | è¯„ä¼°æ–¹æ³• | ç›®æ ‡ |
|------|----------|------|
| å†…å®¹æ·±åº¦ | äººå·¥è¯„å®¡ | æ— "ç©ºæ´é¸¡æ±¤"æ„Ÿ |
| å¯¹è¯è‡ªç„¶åº¦ | äººå·¥è¯„å®¡ | æœ‰æ¥æœ‰å¾€ï¼Œä¸åƒå¿µç¨¿ |
| èŠ‚ç›®å¤šæ ·æ€§ | è¿ç»­æ”¶å¬10æœŸ | æ˜æ˜¾æ„ŸçŸ¥ä¸åŒé£æ ¼ |
| éŸ³ä¹æƒŠå–œæ„Ÿ | ç”¨æˆ·åé¦ˆ | å‘ç°æ–°æ­Œæ‰‹/é£æ ¼ |

### 6.3 æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡ |
|------|--------|------|
| Prompt é•¿åº¦ | 5000+ tokens | æŒ‰ç±»å‹ 1500-2500 |
| AI è°ƒç”¨æ¬¡æ•°/æœŸ | 8-15 æ¬¡ | 5-8 æ¬¡ |
| ç”ŸæˆæˆåŠŸç‡ | 85% | 95% |
| å†…å­˜å ç”¨ | æ— ç›‘æ§ | <500MB |

---

## é™„å½•

### A. æ–°æ–‡ä»¶æ¨¡æ¿

#### show-config.ts
```typescript
import { ShowType } from './cast-system';

export type MusicPurpose = 'main' | 'background' | 'transition_only';

export interface ShowConfig {
    type: ShowType;
    talkRatio: [number, number];
    musicRatio: [number, number];
    musicPurpose: MusicPurpose;
    requiredTools: string[];
    optionalTools: string[];
    promptTemplate: string;
}

export const SHOW_CONFIGS: Record<ShowType, ShowConfig> = {
    // ...
};

export function getShowConfig(type: ShowType): ShowConfig {
    return SHOW_CONFIGS[type] || SHOW_CONFIGS.talk;
}
```

#### prompt-templates/base.ts
```typescript
import { RADIO } from '@shared/utils/constants';

export function getBasePrompt(): string {
    return `
## ğŸ“» ç”µå°èº«ä»½
- ç”µå°åç§°ï¼š${RADIO.NAME} (${RADIO.SLOGAN})
- é¢‘ç‡ï¼š${RADIO.FREQUENCY}

## ğŸ“ è¾“å‡ºæ ¼å¼
ä¸¥æ ¼æŒ‰ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºï¼š
{
  "id": "å”¯ä¸€ID",
  "title": "èŠ‚ç›®æ ‡é¢˜",
  "estimatedDuration": æ•°å­—,
  "blocks": [...]
}
`;
}
```

### B. æµ‹è¯•æ¸…å•

```bash
# Phase 1 æµ‹è¯•
npm test -- --grep "SubtitleDisplay"
npm test -- --grep "MailboxDrawer"

# Phase 2 æµ‹è¯•
npm test -- --grep "cast-system"
npm test -- --grep "show-config"

# æ‰‹åŠ¨æµ‹è¯•
# 1. è¿ç»­ç”Ÿæˆ 10 æœŸèŠ‚ç›®ï¼Œæ£€æŸ¥ç±»å‹åˆ†å¸ƒ
# 2. åœ¨ 320px è®¾å¤‡ä¸Šæµ‹è¯• MailboxDrawer
# 3. éªŒè¯éŸ³ä¹æ­Œæ‰‹ä¸è¿ç»­é‡å¤
```

---

*æ–‡æ¡£ç»´æŠ¤è€…: AI Assistant*
*æœ€åæ›´æ–°: 2026-02-08*
