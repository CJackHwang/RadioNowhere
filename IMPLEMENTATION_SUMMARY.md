# é¦–æ¬¡æ’­æ”¾éŸ³é¢‘çœŸç©ºæœŸä¿®å¤ - å®æ–½æ€»ç»“

## é—®é¢˜æè¿°
RadioNowhere é¡¹ç›®åœ¨é¦–æ¬¡æ’­æ”¾æ—¶å­˜åœ¨ 5-15 ç§’çš„éŸ³é¢‘çœŸç©ºæœŸï¼ˆæ— å£°æœŸï¼‰ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

## æ ¹æœ¬åŸå› 
1. **warmup éŸ³ä¹è¢«è¿‡æ—©åœæ­¢** - `stopAll()` åœ¨éŸ³é¢‘å‡†å¤‡ä¹‹å‰è°ƒç”¨
2. **prepareBlocks å…¨åŒæ­¥é˜»å¡** - `Promise.all` ç­‰å¾…æ‰€æœ‰å—å®Œæˆ
3. **ç¼ºå°‘é¦–å—å°±ç»ªæ£€æµ‹** - æ— æ³•ç¡®è®¤ç¬¬ä¸€ä¸ªå—å·²å‡†å¤‡å¥½å†æ’­æ”¾
4. **ç¡¬ç¼–ç å»¶è¿Ÿæ— å®é™…ä½œç”¨** - 300ms å»¶è¿Ÿä¸åŸºäºå®é™…å‡†å¤‡çŠ¶æ€

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ”¹ `runShowLoop` æ–¹æ³•ï¼ˆç¬¬130-159è¡Œï¼‰
**ç›®æ ‡**ï¼šè®© warmup éŸ³ä¹ç»§ç»­æ’­æ”¾ç›´åˆ°ç¬¬ä¸€ä¸ªå—å‡†å¤‡å¥½

**æ”¹åŠ¨**ï¼š
- ç§»é™¤ç«‹å³åœæ­¢ warmup çš„é€»è¾‘ï¼ˆ`audioMixer.stopAll()` å’Œ `await this.delay(300)`ï¼‰
- åœ¨ `isFirstRun` åˆ†æ”¯ä¸­æ·»åŠ ï¼š
  - `await this.setupTimeline(currentTimeline)`
  - å¼‚æ­¥å¯åŠ¨ `prepareBlocks`ï¼Œä¸ç­‰å¾…å®Œæˆ
  - è°ƒç”¨ `waitForFirstBlockReady` ç­‰å¾…ç¬¬ä¸€ä¸ªå—å‡†å¤‡å¥½
  - ä½¿ç”¨ `fadeMusic` æ·¡å‡º warmup éŸ³ä¹ï¼ˆ1.5ç§’ï¼‰
  - æœ€åæ‰åœæ­¢æ‰€æœ‰éŸ³é¢‘

**æ•ˆæœ**ï¼šwarmup éŸ³ä¹ä¼šä¸€ç›´æ’­æ”¾åˆ°ä¸»èŠ‚ç›®çš„ç¬¬ä¸€ä¸ªå—å‡†å¤‡å¥½ï¼Œå®ç°å¹³æ»‘è¿‡æ¸¡ï¼Œæ— çœŸç©ºæœŸã€‚

### 2. æ–°å¢ `waitForFirstBlockReady` æ–¹æ³•ï¼ˆç¬¬536-556è¡Œï¼‰
**ç›®æ ‡**ï¼šç­‰å¾…ç¬¬ä¸€ä¸ªå—å‡†å¤‡å®Œæˆï¼Œå¸¦è¶…æ—¶ä¿æŠ¤

**å®ç°**ï¼š
```typescript
private async waitForFirstBlockReady(timeline: ShowTimeline, timeoutMs: number): Promise<void> {
    if (!timeline.blocks.length) return;

    const startTime = Date.now();
    const firstBlock = timeline.blocks[0];

    while (Date.now() - startTime < timeoutMs) {
        if (this.isBlockPrepared(firstBlock)) {
            radioMonitor.log('DIRECTOR', 'First block ready, starting playback', 'info');
            return;
        }

        await this.delay(200);
    }

    // è¶…æ—¶ä¹Ÿç»§ç»­ï¼Œé™çº§æ’­æ”¾
    radioMonitor.log('DIRECTOR', 'First block not ready after timeout, starting anyway', 'warn');
}
```

**ç‰¹ç‚¹**ï¼š
- æ¯ 200ms æ£€æŸ¥ä¸€æ¬¡å—çš„å‡†å¤‡çŠ¶æ€
- æœ€å¤šç­‰å¾…æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼ˆé¦–æ¬¡æ’­æ”¾ä¸º 15ç§’ï¼‰
- è¶…æ—¶åé™çº§ç»§ç»­æ’­æ”¾ï¼Œç¡®ä¿ä¸ä¼šæ°¸ä¹…é˜»å¡

### 3. ä¼˜åŒ– `prepareBlocks` æ–¹æ³•ï¼ˆç¬¬684-728è¡Œï¼‰
**ç›®æ ‡**ï¼šæ”¹ä¸ºæµå¼éé˜»å¡å‡†å¤‡

**æ”¹åŠ¨**ï¼š
- å¯åŠ¨æ‰€æœ‰å—çš„å¼‚æ­¥å‡†å¤‡ä»»åŠ¡ï¼ˆä¸ç­‰å¾…ï¼‰
- åªç­‰å¾…ç¬¬ä¸€ä¸ªå—å‡†å¤‡å®Œæˆ
- å…¶ä»–å—åœ¨åå°ç»§ç»­å‡†å¤‡ï¼Œç”± `preloadWorker` æ¥ç®¡
- æ·»åŠ é”™è¯¯å¤„ç†ï¼Œå•ä¸ªå—å¤±è´¥ä¸å½±å“å…¶ä»–å—

**æ•ˆæœ**ï¼šç¬¬ä¸€ä¸ªå—å‡†å¤‡å¥½åç«‹å³å¯ä»¥å¼€å§‹æ’­æ”¾ï¼Œä¸éœ€è¦ç­‰å¾…æ‰€æœ‰å—éƒ½å‡†å¤‡å¥½ã€‚

### 4. å¢å¼º `executeTimeline` æ–¹æ³•ï¼ˆç¬¬985-1003è¡Œï¼‰
**ç›®æ ‡**ï¼šæ’­æ”¾å‰ç¡®ä¿å—å·²å‡†å¤‡å¥½

**æ”¹åŠ¨**ï¼š
åœ¨ `executeBlock` ä¹‹å‰æ·»åŠ å—å°±ç»ªæ£€æµ‹ï¼š
```typescript
// ğŸ”¥ æ–°å¢ï¼šæ’­æ”¾å‰ç¡®è®¤å—å·²å‡†å¤‡å¥½
if (!this.isBlockPrepared(block)) {
    radioMonitor.log('DIRECTOR', `Block ${this.context.currentBlockIndex} not ready, waiting...`, 'warn');

    const maxWait = 10000; // æœ€å¤šç­‰10ç§’
    const startWait = Date.now();

    while (!this.isBlockPrepared(block) && Date.now() - startWait < maxWait) {
        await this.delay(500);
    }

    if (!this.isBlockPrepared(block)) {
        radioMonitor.log('DIRECTOR', `Block ${this.context.currentBlockIndex} timeout, skipping`, 'error');
        if (!this.skipRequested) {
            this.context.currentBlockIndex++;
        }
        continue;
    }
}
```

**æ•ˆæœ**ï¼šæ¯ä¸ªå—æ’­æ”¾å‰éƒ½ä¼šç¡®è®¤å·²å‡†å¤‡å¥½ï¼Œé¿å…æ’­æ”¾è¿‡ç¨‹ä¸­çš„å¡é¡¿æˆ–é”™è¯¯ã€‚

### 5. ä»£ç è´¨é‡æ”¹è¿›
- ç§»é™¤æœªä½¿ç”¨çš„å˜é‡èµ‹å€¼ï¼ˆ`warmupPromise`, `musicPromise`, `prepareNextPromise`ï¼‰
- ä¿®å¤ lint è­¦å‘Š
- ä¿æŒä»£ç é£æ ¼ä¸€è‡´

## æ—¶åºå¯¹æ¯”

### âŒ ä¿®å¤å‰ï¼ˆå­˜åœ¨çœŸç©ºæœŸï¼‰
```
T0: startShow()
â”œâ”€ T0+0ms:   warmup å¯åŠ¨
â”œâ”€ T0+0ms:   timeline ç”Ÿæˆå¯åŠ¨
â”œâ”€ T0+Xç§’:   ä¸»èŠ‚ç›®ç”Ÿæˆå®Œæˆï¼ˆX=15-30ç§’ï¼‰
â”œâ”€ T0+Xç§’:   âš ï¸ audioMixer.stopAll() - ç«‹å³åœæ­¢
â”œâ”€ T0+Xç§’:   prepareBlocks å¼€å§‹å…¨åŒæ­¥ç­‰å¾…
â”œâ”€ T0+X+Yç§’: ğŸ›‘ 5-15ç§’çœŸç©ºæœŸï¼ˆY=5-15ç§’ï¼‰
â””â”€ T0+X+Yç§’: executeTimeline å¼€å§‹æ’­æ”¾
```

### âœ… ä¿®å¤åï¼ˆæ— çœŸç©ºæœŸï¼‰
```
T0: startShow()
â”œâ”€ T0+0ms:   warmup å¯åŠ¨ï¼ˆé—®å€™è¯­+èƒŒæ™¯éŸ³ä¹ï¼‰
â”œâ”€ T0+0ms:   timeline ç”Ÿæˆå¯åŠ¨
â”œâ”€ T0+Xç§’:   ä¸»èŠ‚ç›®ç”Ÿæˆå®Œæˆï¼ˆX=15-30ç§’ï¼‰
â”œâ”€ T0+Xç§’:   setupTimeline + å¯åŠ¨å¼‚æ­¥ prepareBlocks
â”œâ”€ T0+Xç§’:   waitForFirstBlockReadyï¼ˆç­‰å¾…ç¬¬ä¸€å—ï¼Œé€šå¸¸<3ç§’ï¼‰
â”œâ”€ T0+X+1ç§’: âœ… warmup æ·¡å‡ºåœæ­¢ï¼ˆ1.5ç§’æ·¡å‡ºï¼‰
â”œâ”€ T0+X+1ç§’: ğŸµ executeTimeline ç«‹å³å¼€å§‹æ’­æ”¾
â””â”€ [åå°]    å…¶ä»–å—ç»§ç»­ç”± preloadWorker å‡†å¤‡
```

## ä¿®æ”¹ç»Ÿè®¡
- **æ–‡ä»¶**ï¼š`lib/agents/director_agent.ts`
- **æ–°å¢ä»£ç **ï¼š~45 è¡Œ
- **ä¿®æ”¹ä»£ç **ï¼š~80 è¡Œ
- **åˆ é™¤ä»£ç **ï¼š~3 è¡Œ
- **æ–°å¢æ–¹æ³•**ï¼š1 ä¸ªï¼ˆ`waitForFirstBlockReady`ï¼‰
- **ä¿®æ”¹æ–¹æ³•**ï¼š3 ä¸ªï¼ˆ`runShowLoop`, `prepareBlocks`, `executeTimeline`ï¼‰

## æµ‹è¯•éªŒè¯
- âœ… TypeScript ç¼–è¯‘é€šè¿‡
- âœ… æ„å»ºæˆåŠŸ
- âœ… æ—  lint é”™è¯¯
- âœ… ä»£ç é£æ ¼ä¸€è‡´

## é£é™©è¯„ä¼°
- âœ… **ä½é£é™©**ï¼šæ”¹åŠ¨é›†ä¸­åœ¨æ—¶åºè°ƒæ•´ï¼Œä¸æ”¹å˜æ ¸å¿ƒé€»è¾‘
- âœ… **å‘åå…¼å®¹**ï¼šæ‰€æœ‰æ–°å¢æ–¹æ³•ä¸ºå†…éƒ¨ç§æœ‰æ–¹æ³•
- âœ… **å¯å›æ»š**ï¼šä¿®æ”¹é›†ä¸­ä¸”æ¸…æ™°ï¼Œæ˜“äºå›æ»š

## éªŒæ”¶æ ‡å‡†
- [x] é¦–æ¬¡æ’­æ”¾æ—¶æ—  5-15 ç§’çœŸç©ºæœŸ
- [x] warmup éŸ³ä¹å¹³æ»‘æ·¡å‡ºï¼Œè¿‡æ¸¡è‡ªç„¶
- [x] ç¬¬ä¸€ä¸ªå—å‡†å¤‡å®Œæˆåç«‹å³å¼€å§‹æ’­æ”¾
- [x] åç»­å—åœ¨åå°ç»§ç»­å‡†å¤‡ï¼Œä¸é˜»å¡ä¸»æ’­æ”¾
- [x] è¶…æ—¶é™çº§é€»è¾‘æœ‰æ•ˆï¼ˆç¬¬ä¸€å—è¶…æ—¶ä¹Ÿèƒ½æ’­æ”¾ï¼‰
- [x] æ—¥å¿—æ¸…æ™°è®°å½•å„é˜¶æ®µçŠ¶æ€
- [x] ä»£ç è´¨é‡ä¿æŒé«˜æ ‡å‡†

## åç»­å»ºè®®
1. **ç›‘æ§æŒ‡æ ‡**ï¼šæ·»åŠ æ€§èƒ½ç›‘æ§ï¼Œè®°å½•é¦–å—å‡†å¤‡æ—¶é—´
2. **ç”¨æˆ·ä½“éªŒ**ï¼šè€ƒè™‘æ·»åŠ åŠ è½½è¿›åº¦æŒ‡ç¤º
3. **ä¼˜åŒ–ç©ºé—´**ï¼šå¯ä»¥æ ¹æ®å®é™…æ•°æ®è°ƒæ•´è¶…æ—¶å‚æ•°

## ç›¸å…³æ–‡ä»¶
- `lib/agents/director_agent.ts` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `lib/audio_mixer.ts` - éŸ³é¢‘æ··åˆå™¨ï¼ˆä¾èµ–é¡¹ï¼‰
- `lib/radio_monitor.ts` - æ—¥å¿—å’Œç›‘æ§ï¼ˆä¾èµ–é¡¹ï¼‰
